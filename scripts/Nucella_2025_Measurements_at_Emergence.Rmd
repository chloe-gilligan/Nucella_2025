---
title: "Nucella_2025_Measurements_at_Emergence"
author: "Chloé Gilligan"
date: "2025-10-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(dplyr)
library(readr)
```


```{r}
nucella_emergence_meas <- read_csv("~/Desktop/Repositories/Nucella_2025/data/NL_2025_master_measurements_with_metadata.csv")
```

```{r}
# Trim whitespace and convert to factors
nucella_emergence_meas <- nucella_emergence_meas %>%
  mutate(across(where(is.character), ~ as.factor(trimws(.x))),
         length = as.numeric(as.character(length)),
         width  = as.numeric(as.character(width)))
```

```{r}
table(nucella_emergence_meas$sample_name)
```


```{r}
nucella_emergence_meas <- nucella_emergence_meas %>%
  mutate(
    across(where(is.character), ~ as.factor(trimws(.x))),  # remove whitespace and convert to factor
    length = as.numeric(as.character(length)),            # safely convert to numeric
    width  = as.numeric(as.character(width))
  )
```

```{r}
# Calculate the average of snail 1–10 for each sample_name
nucella_emergence_averages <- nucella_emergence_meas %>%
  group_by(sample_name, color, emergence_date, site, batch, predation, temperature) %>%
  summarise(
    avg_length = mean(length, na.rm = TRUE),
    avg_width  = mean(width, na.rm = TRUE))
    #n_snails   = n(),          # number of snails per sample
    #.groups = "drop"
  #)
```

```{r}
str(nucella_emergence_averages)
head(nucella_emergence_averages)
```



```{r}
# Join the averages back to the main dataset
#nucella_emergence_meas  <- nucella_emergence_meas  %>%
  #left_join(snail_avg, by = "sample_name")
```

```{r}
# new CSV
write_csv(nucella_emergence_averages, "~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_average_measurements.csv")
```



#Running with reps
```{r}
#nucella_averages_replicates <- read_csv("~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_average_measurements.csv")
```


```{r}
# Read your CSV — adjust the path
#nucella_averages_replicates <- read_csv("~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_average_measurements.csv",
                         col_types = cols(
                           sample_name = col_factor(),
                           color = col_factor(),
                           site = col_factor(),
                           predation = col_factor(),
                           temperature = col_factor(),
                           replicate_hand = col_factor(),
                           batch = col_factor()
                         ))
```





```{r}

library(dplyr)
library(readr)
library(lme4)
library(car)  # for Anova()

# Read your CSV — adjust the path
nucella_emergence_measurement <- read_csv("~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_average_measurements.csv",
                         col_types = cols(
                           sample_name = col_factor(),
                           color = col_factor(),
                           site = col_factor(),
                           predation = col_factor(),
                           temperature = col_factor(),
                           replicate = col_factor(),
                           batch = col_factor()
                         ))

nucella_emergence_averages <- nucella_emergence_measurement %>%
  group_by(sample_name, color, emergence_date, site, batch, predation, temperature) %>%
  summarise(
    avg_length = mean(length, na.rm = TRUE),
    avg_width  = mean(width, na.rm = TRUE),
    n_snails   = n(),
    .groups = "drop"
  )



# Check structure
str(nucella_emergence_measurement)
View(nucella_emergence_measurement)

```

```{r}
library(lme4)
library(car)
str(nucella_emergence_measurement)

#keep this every time
options(contrasts = c("contr.sum","contr.poly"))
getOption("contrasts")


m1 <- lmer(avg_length ~ predation * temperature + (1|site) + (1|batch), 
           data = nucella_emergence_averages, REML=TRUE)

Anova(m1, test="F", type="III")
summary(m1)

#site as factor instead of random
m2 <- lmer(avg_length ~ predation * temperature * site + (1|batch), 
           data = nucella_emergence_averages, REML=TRUE)

Anova(m2, test="F", type="III")
summary(m1)


```

#Sarah code

```{r}
plot <- ggplot(na.omit(avgs), aes(x=early_salinity, y=tot_avg,color = as.factor(late_salinity), shape=late_salinity, fill = late_salinity))
plot2 <- plot+geom_errorbar(aes(ymin=tot_avg-SE, ymax=tot_avg+SE), width=0.1) +
  geom_point(size=8, stroke=1) + theme_grey() +scale_color_manual(values=c("#660066", "#99CC99"))+scale_shape_manual(values=c(22, 21))+ scale_fill_manual(values=c("#660066", "#99CC99"))+
  theme(legend.text=element_text(size=14),strip.text.x = element_text(size = 14), strip.background = element_blank(),panel.border = element_rect(fill= NA, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1), axis.line = element_line(colour = "black", size=.25), axis.text.x = element_text(size=14, color="black"), axis.text.y = element_text(size=14, color="black"), axis.title=element_text(size=18, color="black")) +
          scale_x_discrete(name="Early Salinity (psu)") + scale_y_continuous(name="No. total nauplii")+ guides(fill = FALSE)
plot2
```

#Sophie code
```{r}
library(dplyr)
library(ggplot2)
library(Rmisc)

std.error <- function(x, na.rm = TRUE) {
  x <- if (na.rm) x[!is.na(x)] else x
  sd(x) / sqrt(length(x))
}

#mean and SE by predation × temperature
summary_stats_length <- nucella_emergence_averages %>%
  group_by(predation, temperature) %>%
  mutate(
    mean_length = mean(avg_length, na.rm = TRUE),
    se_length = std.error(avg_length, na.rm = TRUE)
    #.groups = "drop"
  )

summary_stats_t <- Growth_Data_forR_full %>%
  group_by(Phase_1_treat, Phase_2_treat) %>%
  mutate(
    mean_growth = mean((Actual_tissue_growth_mg/whole_growth_mg), na.rm = TRUE),
    se_growth = std.error((Actual_tissue_growth_mg/whole_growth_mg), na.rm = TRUE))


# reorder factors?
#summary_stats_length$predation <- factor(summary_stats_length$predation,
                                     #    levels = c("No crab", "Crab"))
#summary_stats_length$temperature <- factor(summary_stats_length$temperature,
                                         #  levels = c("Ambient", "Heated"))


ggplot(summary_stats_length,
       aes(x = predation, y = mean_length, color = temperature, shape = temperature, fill = temperature)) +
  geom_errorbar(aes(ymin = mean_length - se_length, ymax = mean_length + se_length),
                width = 0.1, position = position_dodge(0.3)) +
  geom_point(size = 5, stroke = 1, position = position_dodge(0.3)) +
  scale_color_manual(values = c("Ambient" = "#00B2EE", "Heated" = "#EE2C2C")) +
  scale_fill_manual(values = c("Ambient" = "#00B2EE", "Heated" = "#EE2C2C")) +
  scale_shape_manual(values = c(21, 22)) +
  theme_classic(base_size = 18) +
  labs(x = "Predation Treatment",
       y = "Mean Snail Length (mm)",
       color = "Temperature",
       shape = "Temperature") +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 16, color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )


```

```{r}
ggplot(summary_stats_length,
       aes(x = predation, y = mean_length, color = temperature, shape = temperature, fill = temperature)) +
  geom_errorbar(aes(ymin = mean_length - se_length, ymax = mean_length + se_length),
                width = 0.1, position = position_dodge(0.3)) +
  geom_point(size = 5, stroke = 1, position = position_dodge(0.3)) +
  scale_color_manual(values = c("Ambient" = "#00B2EE", "Heated" = "#EE2C2C")) +
  

  scale_fill_manual(values = c("Ambient" = "#00B2EE", "Heated" = "#EE2C2C")) +
  scale_shape_manual(values = c(21, 22)) +
  theme_classic(base_size = 18) +
  labs(x = "Predation Treatment",
       y = "Mean Snail Length (mm)",
       color = "Temperature",
       shape = "Temperature") +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 16, color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )
```








