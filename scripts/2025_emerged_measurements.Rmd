---
title: "2025_emerged_measurements"
author: "Chlo√© Gilligan"
date: "2025-07-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(readxl)
library(tidyverse) 
```

#What worked for the first half of the table- creating the master spreadsheet 
```{r}
# Load libraries
library(tidyr)
library(dplyr)
library(ggplot2)
library(readxl)
library(tidyverse)

# Getting to folder with CSVs
path <- "~/Desktop/repositories/Nucella_2025/data/NL_2025_measurements_csv"
files <- list.files(path, pattern = "\\.csv$", full.names = TRUE)

# Function to process each CSV
process_file <- function(file) {
  # Extract metadata from filename
  fname <- basename(file)
  parts <- strsplit(fname, "_")[[1]]
  emergence_date <- parts[1]
  sample_name <- parts[2]
  photo_number <- gsub("\\.csv", "", parts[3])
  
  # Read CSV and keep only Length and Comment
  df <- read_csv(file, show_col_types = FALSE) %>%
    select(`Length [mm]`, Comment) %>%
    filter(!is.na(Comment)) %>%
    mutate(`Length [mm]` = as.numeric(`Length [mm]`))
  
  # Separate length vs width and extract snail_number
  df <- df %>%
    mutate(
      type = ifelse(grepl("_L_", Comment), "length", "width"),
      snail_number = as.numeric(str_extract(Comment, "\\d+$"))
    ) %>%
    select(snail_number, type, value = `Length [mm]`)
  
  # Resolve duplicates: keep only first measurement per snail_number & type
  df <- df %>%
    group_by(snail_number, type) %>%
    slice(1) %>%
    ungroup()
  
  # Pivot wider so each snail has length & width in one row
  df_wide <- df %>%
    pivot_wider(names_from = type, values_from = value)
  
  # Add metadata columns
  df_wide <- df_wide %>%
    mutate(
      sample_name = sample_name,
      emergence_date = emergence_date,
      photo_number = photo_number
    ) %>%
    select(sample_name, emergence_date, photo_number, snail_number, length, width)
  
  return(df_wide)
}

# Combine all CSVs
master <- purrr::map_dfr(files, process_file)

# Save initial master CSV
write_csv(master, "~/Desktop/repositories/Nucella_2025/data/NL_2025_master_measurements.csv")

# Example filename breakdown
fname <- basename(files[1])
parts <- strsplit(fname, "_")[[1]]
emergence_date <- parts[1]
sample_name <- parts[2]   # e.g. "RIP4"
photo_number <- gsub("\\.csv", "", parts[3])

# Parse metadata from sample name
site_code <- substr(sample_name, 1, 2)    # RI, CR, BR
color_code <- substr(sample_name, 3, 3)   # P, R, B, G
batch <- as.numeric(substr(sample_name, 4, 4))  # renamed from replicate

# Decode site
site <- case_when(
  site_code == "RI" ~ "Ram Island",
  site_code == "CR" ~ "Castle Rock",
  site_code == "BR" ~ "Bass Rock"
)

# Decode color
color <- case_when(
  color_code == "P" ~ "Pink",
  color_code == "R" ~ "Red",
  color_code == "B" ~ "Blue",
  color_code == "G" ~ "Green"
)

# Decode Predator (formerly treatment)
predation <- case_when(
  color_code %in% c("R", "B") ~ "Crab",
  color_code %in% c("P", "G") ~ "No crab"
)

# Decode temperature
temperature <- case_when(
  color_code %in% c("P", "R") ~ "Heated",
  color_code %in% c("B", "G") ~ "Ambient"
)

# Print extracted metadata
cat(emergence_date, sample_name, photo_number, site, color, predation, temperature, batch, "\n")

write_csv(master, "~/Desktop/repositories/Nucella_2025/data/NL_2025_master_measurements.csv")


```

#Adding treatment and temperature 
```{r}
master <- master %>%
  mutate(
    # Parse site, color, and batch from sample_name
    site_code = substr(sample_name, 1, 2),
    color_code = substr(sample_name, 3, 3),
    batch = as.numeric(substr(sample_name, 4, 4)),

    # Map codes to full labels
    site = case_when(
      site_code == "RI" ~ "Ram Island",
      site_code == "CR" ~ "Castle Rock",
      site_code == "BR" ~ "Bass Rock",
      TRUE ~ NA_character_
    ),
    color = case_when(
      color_code == "P" ~ "Pink",
      color_code == "R" ~ "Red",
      color_code == "B" ~ "Blue",
      color_code == "G" ~ "Green",
      TRUE ~ NA_character_
    ),
    predation = case_when(
      color_code %in% c("R", "B") ~ "Crab",
      color_code %in% c("P", "G") ~ "No crab",
      TRUE ~ NA_character_
    ),
    temperature = case_when(
      color_code %in% c("P", "R") ~ "Heated",
      color_code %in% c("B", "G") ~ "Ambient",
      TRUE ~ NA_character_
    )
  ) %>%
  select(sample_name, emergence_date, site, color, batch,
         predation, temperature, photo_number, snail_number, length, width)


#trying to make replicate numbers
master <- master %>%
  distinct(sample_name, color, .keep_all = TRUE) %>%
  arrange(color, sample_name) %>%
  mutate(replicate = ave(seq_along(sample_name), color, FUN = seq_along)) %>%
  select(sample_name, color, replicate) %>%
  right_join(master, by = c("sample_name", "color")) %>%
  relocate(replicate, .after = width)


```


```{r}
head(master)
```

#Exporting complete table with all measurements
```{r}
main_path <- "~/Desktop/repositories/Nucella_2025/data"
write_csv(master, file.path(main_path, "NL_2025_master_measurements_with_metadata.csv"))
```


#Trying to plot
```{r}
library(ggplot2)

# Plot with predation color
ggplot(master, aes(x = length, y = width, color = predation)) +
  geom_point(size = 2, alpha = 0.7) +
  labs(
    title = "Snail Length vs Width by Predation Treatment",
    x = "Length (mm)",
    y = "Width (mm)",
    color = "Predation"
  ) +
  theme_minimal()
```
```{r}
library(ggplot2)

ggplot(master, aes(x = length, y = width)) +
  geom_point(aes(color = temperature, shape = predation), size = 3, alpha = 0.8) +
  scale_color_manual(values = c("Ambient" = "blue", "Heated" = "red")) +
  labs(
    x = "Length (mm)",
    y = "Width (mm)",
    color = "Temperature",
    shape = "Predation"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    legend.title = element_text(size = 12)
  )
```

```{r}
ggplot(master, aes(x = length, y = width)) +
  geom_point(aes(color = temperature), size = 2.5, alpha = 0.7) +
  facet_wrap(~ treatment) +
  labs(
    title = "Snail Length vs Width by Treatment",
    x = "Length (mm)",
    y = "Width (mm)"
  ) +
  theme_minimal()
```


```{r}
Growth_Data_forR <- read_csv("Desktop/Manuscripts 2019-/**1.PUBLISHED/Oyster Carryover19/Data for Figshare/3.OysterGrowth&Ncontent.csv", 
                             
                             col_types = cols(Year1DO = col_factor(), Year1Temp=col_factor(), Year2DO=col_factor(), Year2Temp=col_factor(), Year1Rep=col_factor(), Year2Rep=col_factor(), OverallTreatmentCombination=col_factor())) #changing to factor


str(Growth_Data_forR) #looking at columns
View(Growth_Data_forR)
levels(Growth_Data_forR$Phase1DO) # checking levels
levels(Growth_Data_forR$Phase1Temp)
levels(Growth_Data_forR$Phase2DO)
levels(Growth_Data_forR$Phase2temp)
levels(Growth_Data_forR$NewPhase1Rep)
```

```{r}
#LMMs and ANCOVAs for response variables
#set contrasts
options(contrasts = c("contr.sum","contr.poly"))
getOption("contrasts")
```

```{r}
m2 <- lmer(length~ crab*temp+(1|site)+(1|batch)+(1|replicate), data = Growth_Data_forR, REML=TRUE)
Anova(m2, test="F", type="III")


#take out replicate once averages of length and width are taken for each sample
```



