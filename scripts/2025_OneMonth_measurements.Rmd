---
title: "2025_OneMonth_measurements"
author: "Chloé Gilligan"
date: "2025-10-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(readxl)
library(tidyverse) 
```

#What worked for the first half of the table- creating the master spreadsheet 
```{r}

# Getting to folder with CSVs
path <- "~/Desktop/repositories/Nucella_2025/data/2025_OneMonth_measurements_csv"
files <- list.files(path, pattern = "\\.csv$", full.names = TRUE)

# Function to process each CSV
process_file <- function(file) {
  # Extract metadata from filename
  fname <- basename(file)
  parts <- strsplit(fname, "_")[[1]]
  emergence_date <- parts[1]
  sample_name <- parts[2]
  photo_number <- gsub("\\.csv", "", parts[3])
  
  # Read CSV and keep only Length and Comment
  df <- read_csv(file, show_col_types = FALSE) %>%
    select(`Length [mm]`, Comment) %>%
    filter(!is.na(Comment)) %>%
    mutate(`Length [mm]` = as.numeric(`Length [mm]`))
  
  # Separate length vs width and extract snail_number
  df <- df %>%
    mutate(
      type = ifelse(grepl("_L_", Comment), "length", "width"),
      snail_number = as.numeric(str_extract(Comment, "\\d+$"))
    ) %>%
    select(snail_number, type, value = `Length [mm]`)
  
  # Resolve duplicates: keep only first measurement per snail_number & type
  df <- df %>%
    group_by(snail_number, type) %>%
    slice(1) %>%
    ungroup()
  
  # Pivot wider so each snail has length & width in one row
  df_wide <- df %>%
    pivot_wider(names_from = type, values_from = value)
  
  # Add metadata columns
  df_wide <- df_wide %>%
    mutate(
      sample_name = sample_name,
      emergence_date = emergence_date,
      photo_number = photo_number
    ) %>%
    select(sample_name, emergence_date, photo_number, snail_number, length, width)
  
  return(df_wide)
}

# Combine all CSVs
master_OneMonth <- purrr::map_dfr(files, process_file)

# Save initial master CSV
write_csv(master_OneMonth, "~/Desktop/repositories/Nucella_2025/data/2025_OneMonth_measurements.csv")

# Example filename breakdown
fname <- basename(files[1])
parts <- strsplit(fname, "_")[[1]]
emergence_date <- parts[1]
sample_name <- parts[2]   # e.g. "RIP4"
photo_number <- gsub("\\.csv", "", parts[3])

# Parse metadata from sample name
site_code <- substr(sample_name, 1, 2)    # RI, CR, BR
color_code <- substr(sample_name, 3, 3)   # P, R, B, G
batch <- as.numeric(substr(sample_name, 4, 4))  # renamed from replicate

# Decode site
site <- case_when(
  site_code == "RI" ~ "Ram Island",
  site_code == "CR" ~ "Castle Rock",
  site_code == "BR" ~ "Bass Rock"
)

# Decode color
color <- case_when(
  color_code == "P" ~ "Pink",
  color_code == "R" ~ "Red",
  color_code == "B" ~ "Blue",
  color_code == "G" ~ "Green"
)

# Decode Predator (formerly treatment)
predation <- case_when(
  color_code %in% c("R", "B") ~ "Crab",
  color_code %in% c("P", "G") ~ "No crab"
)

# Decode temperature
temperature <- case_when(
  color_code %in% c("P", "R") ~ "Heated",
  color_code %in% c("B", "G") ~ "Ambient"
)

# Print extracted metadata
cat(emergence_date, sample_name, photo_number, site, color, predation, temperature, batch, "\n")

write_csv(master_OneMonth, "~/Desktop/repositories/Nucella_2025/data/2025_OneMonth_measurements.csv")

```

```{r}
master_OneMonth <- master_OneMonth %>%
  mutate(
    # Parse site, color, and batch from sample_name
    site_code = substr(sample_name, 1, 2),
    color_code = substr(sample_name, 3, 3),
    batch = as.numeric(substr(sample_name, 4, 4)),

    # Map codes to full labels
    site = case_when(
      site_code == "RI" ~ "Ram Island",
      site_code == "CR" ~ "Castle Rock",
      site_code == "BR" ~ "Bass Rock",
      TRUE ~ NA_character_
    ),
    color = case_when(
      color_code == "P" ~ "Pink",
      color_code == "R" ~ "Red",
      color_code == "B" ~ "Blue",
      color_code == "G" ~ "Green",
      TRUE ~ NA_character_
    ),
    predation = case_when(
      color_code %in% c("R", "B") ~ "Crab",
      color_code %in% c("P", "G") ~ "No crab",
      TRUE ~ NA_character_
    ),
    temperature = case_when(
      color_code %in% c("P", "R") ~ "Heated",
      color_code %in% c("B", "G") ~ "Ambient",
      TRUE ~ NA_character_
    )
  ) %>%
  select(sample_name, emergence_date, site, color, batch,
         predation, temperature, photo_number, snail_number, length, width)


#trying to make replicate numbers
#master_OneMonth <- master_OneMonth %>%
  #distinct(sample_name, color, .keep_all = TRUE) %>%
  #arrange(color, sample_name) %>%
  #mutate(replicate = ave(seq_along(sample_name), color, FUN = seq_along)) %>%
  #select(sample_name, color, replicate) %>%
  #right_join(master, by = c("sample_name", "color")) %>%
  #relocate(replicate, .after = width)
```


```{r}
main_path <- "~/Desktop/repositories/Nucella_2025/data"
write_csv(master_OneMonth, "~/Desktop/repositories/Nucella_2025/data/2025_OneMonth_measurements.csv")
```




#Part two

```{r}
nucella_emergence_meas_OneMonth <- read_csv("~/Desktop/Repositories/Nucella_2025/data/2025_OneMonth_measurements.csv")
```


```{r}
#Convert all character columns to factors
nucella_emergence_meas_OneMonth <- nucella_emergence_meas_OneMonth %>%
  mutate(
    across(where(is.character), as.factor),
    length = as.numeric(length),
    width = as.numeric(width)
  )
```

```{r}
# Calculate the average of snail 1–10 for each sample_name
nucella_emergence_OneMonth_averages <- nucella_emergence_meas_OneMonth %>%
  group_by(sample_name, color, emergence_date, site, batch, predation, temperature) %>%
  summarise(
    avg_length = mean(length, na.rm = TRUE),
    avg_width = mean(width, na.rm = TRUE),
    n_snails = n(),  # optional: shows how many snails per sample
    .groups = "drop"
  )
```

```{r}
# Join the averages back to the main dataset
#nucella_emergence_meas  <- nucella_emergence_meas  %>%
  #left_join(snail_avg, by = "sample_name")
```

```{r}
# new CSV
write_csv(nucella_emergence_OneMonth_averages, "~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_OneMonth_averages.csv")
```

```{r}

nucella_averages_replicates <- read_csv("~/Desktop/Repositories/Nucella_2025/data/nucella_emergence_OneMonth_averages.csv",
                         col_types = cols(
                           sample_name = col_factor(),
                           color = col_factor(),
                           site = col_factor(),
                           predation = col_factor(),
                           temperature = col_factor(),
                           batch = col_factor()
                         ))
```


```{r}
library(lme4)
library(car)
str(nucella_emergence_OneMonth_averages)

#keep this every time
options(contrasts = c("contr.sum","contr.poly"))
getOption("contrasts")


m1 <- lmer(avg_length ~ predation * temperature + (1|site) + (1|batch), 
           data = nucella_emergence_OneMonth_averages, REML=TRUE)

Anova(m1, test="F", type="III")
summary(m1)

#site as factor instead of random
m2 <- lmer(avg_length ~ predation * temperature * site + (1|batch), 
           data = nucella_emergence_OneMonth_averages, REML=TRUE)

Anova(m2, test="F", type="III")
summary(m1)


```









